<app-loms-layout
  organisationName="Loan Origination and Management System"
  solutionName="LOMS"
  [breadcrumb]="breadcrumb"
  basePath="/loms"
>
  <div class="space-y-4">
    <section class="rounded-xl border border-blue-100 bg-white px-6 py-4 shadow-sm">
      <div class="flex flex-col gap-3">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <button
            type="button"
            class="inline-flex h-8 items-center justify-center rounded-md border border-slate-200 bg-white px-3 text-[11px] font-semibold text-slate-700 shadow-sm hover:bg-slate-50"
            (click)="onBackToList()"
          >
            <span class="mr-1">←</span>
            <span>Back to CIB Initiation</span>
          </button>
          <div class="flex flex-wrap items-center gap-4 text-[11px]">
            <div class="space-y-0.5">
              <div class="text-slate-500 uppercase tracking-wide">
                Loan Application Ref
              </div>
              <div class="font-semibold text-slate-900">
                {{ selectedPersona?.appId || '—' }}
              </div>
            </div>
            <div class="space-y-0.5">
              <div class="text-slate-500 uppercase tracking-wide">
                Persona Type
              </div>
              <div class="inline-flex items-center rounded-full bg-blue-50 px-2 py-0.5 text-[10px] font-semibold text-blue-700">
                {{ selectedPersona?.personaType || '—' }}
              </div>
            </div>
            <div class="space-y-0.5">
              <div class="text-slate-500 uppercase tracking-wide">
                Persona Name
              </div>
              <div class="font-semibold text-slate-900">
                {{ selectedPersona?.fullName || '—' }}
              </div>
            </div>
            <div class="space-y-0.5">
              <div class="text-slate-500 uppercase tracking-wide">
                Current CIB Status
              </div>
              <div
                class="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] font-semibold"
                [ngClass]="currentStatusBadgeClasses"
              >
                {{ selectedPersona?.status || 'Not Requested' }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="rounded-xl border border-blue-100 bg-white px-6 py-4 shadow-sm">
      <div class="space-y-3">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-xs font-semibold text-slate-900">
              Persona Selection for CIB Details
            </h2>
            <p class="text-[11px] text-slate-500">
              Click on any row to view detailed CIB information for that persona.
            </p>
          </div>
        </div>
        <div class="mt-1 overflow-x-auto rounded-md border border-slate-200 bg-white">
          <table class="min-w-full border-separate border-spacing-0 text-[11px]">
            <thead>
              <tr class="bg-slate-50 text-left font-semibold uppercase tracking-wide text-slate-500">
                <th class="px-4 py-2">
                  Persona Type
                </th>
                <th class="px-4 py-2">
                  Full Name
                </th>
                <th class="px-4 py-2">
                  National ID Number
                </th>
                <th class="px-4 py-2">
                  Date of Birth
                </th>
                <th class="px-4 py-2">
                  Mobile Number
                </th>
                <th class="px-4 py-2">
                  CIB Status
                </th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 bg-white">
              <tr
                *ngFor="let persona of personas"
                class="text-xs cursor-pointer"
                [class.bg-blue-50]="isRowActive(persona)"
                [class.hover\\:bg-slate-50]="!isRowActive(persona)"
                (click)="setSelectedPersona(persona)"
              >
                <td class="px-4 py-3 align-top text-slate-700">
                  {{ persona.personaType }}
                </td>
                <td class="px-4 py-3 align-top text-slate-900">
                  {{ persona.fullName }}
                </td>
                <td class="px-4 py-3 align-top text-slate-800">
                  {{ persona.nid }}
                </td>
                <td class="px-4 py-3 align-top text-slate-800">
                  {{ persona.dob }}
                </td>
                <td class="px-4 py-3 align-top text-slate-800">
                  {{ persona.mobile }}
                </td>
                <td class="px-4 py-3 align-top">
                  <span
                    class="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] font-semibold"
                    [ngClass]="getStatusBadgeClasses(persona.status)"
                  >
                    {{ persona.status }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="grid gap-4 lg:grid-cols-3">
      <div class="space-y-4 lg:col-span-2">
        <section class="rounded-xl border border-blue-100 bg-white px-6 py-4 shadow-sm">
          <div class="space-y-4">
            <div>
              <h2 class="text-xs font-semibold text-slate-900">
                Persona Identity Details
              </h2>
              <p class="text-[11px] text-slate-500">
                Read-only persona information as captured during loan application.
              </p>
            </div>

            <div class="grid gap-4 md:grid-cols-2">
              <div class="space-y-1">
                <div class="text-[11px] font-medium text-slate-600">
                  Full Name (as per NID)
                </div>
                <div class="rounded-md border border-slate-200 bg-slate-50 px-3 py-2 text-[11px] text-slate-900">
                  {{ selectedPersona?.fullName || '—' }}
                </div>
              </div>
              <div class="space-y-1">
                <div class="text-[11px] font-medium text-slate-600">
                  Persona Type
                </div>
                <div class="rounded-md border border-slate-200 bg-slate-50 px-3 py-2 text-[11px] text-slate-900">
                  {{ selectedPersona?.personaType || '—' }}
                </div>
              </div>
            </div>

            <div class="grid gap-4 md:grid-cols-3">
              <div class="space-y-1">
                <div class="text-[11px] font-medium text-slate-600">
                  National ID Number
                </div>
                <div class="rounded-md border border-slate-200 bg-slate-50 px-3 py-2 text-[11px] text-slate-900">
                  {{ selectedPersona?.nid || '—' }}
                </div>
              </div>
              <div class="space-y-1">
                <div class="text-[11px] font-medium text-slate-600">
                  Date of Birth
                </div>
                <div class="rounded-md border border-slate-200 bg-slate-50 px-3 py-2 text-[11px] text-slate-900">
                  {{ selectedPersona?.dob || '—' }}
                </div>
              </div>
              <div class="space-y-1">
                <div class="text-[11px] font-medium text-slate-600">
                  Mobile Number
                </div>
                <div class="rounded-md border border-slate-200 bg-slate-50 px-3 py-2 text-[11px] text-slate-900">
                  {{ selectedPersona?.mobile || '—' }}
                </div>
              </div>
            </div>

            <div class="space-y-1">
              <div class="text-[11px] font-medium text-slate-600">
                Document Upload
              </div>
              <button
                type="button"
                class="inline-flex h-8 items-center justify-center rounded-md border border-dashed border-slate-300 bg-slate-50 px-3 text-[11px] font-semibold text-slate-700 hover:bg-slate-100"
              >
                Upload Documents
              </button>
              <div class="text-[10px] text-slate-500">
                Supported formats: PDF, JPG, PNG (Max 5MB per file)
              </div>
            </div>
          </div>
        </section>

        <section class="rounded-xl border border-blue-100 bg-white px-6 py-4 shadow-sm">
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <div>
                <h2 class="text-xs font-semibold text-slate-900">
                  Send Back / Escalate
                </h2>
                <p class="text-[11px] text-slate-500">
                  Communicate issues or urgency for this persona.
                </p>
              </div>
            </div>

            <div class="grid gap-4 md:grid-cols-2">
              <div class="space-y-1">
                <div class="text-[11px] font-medium text-slate-700">
                  Action Type <span class="text-red-500">*</span>
                </div>
                <select
                  class="h-9 w-full rounded-md border border-slate-200 bg-white px-2 text-[11px] text-slate-700 outline-none ring-0 focus:border-blue-500 focus:ring-2 focus:ring-blue-100"
                  [(ngModel)]="actionType"
                  [disabled]="!hasSelection"
                >
                  <option value="">Select Action</option>
                  <option value="Send Back to RM">Send Back to RM</option>
                  <option value="Escalate to CPU">Escalate to CPU</option>
                  <option value="Escalate to Manager">Escalate to Manager</option>
                </select>
              </div>
              <div class="space-y-1">
                <div class="text-[11px] font-medium text-slate-700">
                  Remarks <span class="text-red-500">*</span>
                </div>
                <textarea
                  rows="3"
                  class="w-full rounded-md border border-slate-200 bg-white px-2 py-1.5 text-[11px] text-slate-700 outline-none ring-0 focus:border-blue-500 focus:ring-2 focus:ring-blue-100"
                  placeholder="Enter detailed remarks explaining the reason for this action. Minimum 20 characters required."
                  [(ngModel)]="remarks"
                  [disabled]="!hasSelection"
                ></textarea>
              </div>
            </div>

            <div class="flex flex-col gap-2 text-[10px] text-slate-500">
              <span>Minimum 20 characters required.</span>
            </div>

            <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-end">
              <button
                type="button"
                class="inline-flex h-9 items-center justify-center rounded-md border border-slate-200 bg-white px-4 text-[11px] font-semibold text-slate-700 shadow-sm hover:bg-slate-50"
              >
                Cancel
              </button>
              <button
                type="button"
                class="inline-flex h-9 items-center justify-center rounded-md bg-blue-600 px-6 text-[11px] font-semibold text-white shadow-sm hover:bg-blue-700 disabled:bg-slate-200 disabled:text-slate-500 disabled:hover:bg-slate-200"
                (click)="onSubmitAction()"
                [disabled]="!canSubmitAction"
              >
                Submit Action
              </button>
            </div>
          </div>
        </section>
      </div>

      <div class="space-y-4">
        <section class="rounded-xl border border-blue-100 bg-white px-4 py-4 shadow-sm">
          <div class="space-y-3">
            <div>
              <h2 class="text-xs font-semibold text-slate-900">
                CIB Status Timeline
              </h2>
              <p class="text-[11px] text-slate-500">
                Complete audit trail of CIB request lifecycle.
              </p>
            </div>
            <ol class="space-y-2 text-[11px]">
              <li
                *ngFor="let item of timelineItems"
                class="flex items-start gap-2"
              >
                <div>
                  <div
                    class="flex h-5 w-5 items-center justify-center rounded-full text-[10px] font-semibold"
                    [ngClass]="{
                      'bg-emerald-500 text-white': item.status === 'done',
                      'bg-blue-500 text-white': item.status === 'active',
                      'bg-slate-200 text-slate-500': item.status === 'pending'
                    }"
                  >
                    <ng-container [ngSwitch]="item.status">
                      <span *ngSwitchCase="'done'">✓</span>
                      <span *ngSwitchDefault>•</span>
                    </ng-container>
                  </div>
                </div>
                <div>
                  <div class="font-semibold text-slate-900">
                    {{ item.label }}
                  </div>
                  <div class="text-[11px] text-slate-500">
                    {{ item.description }}
                  </div>
                </div>
              </li>
            </ol>
          </div>
        </section>

        <section class="rounded-xl border border-blue-100 bg-white px-4 py-4 shadow-sm">
          <div class="space-y-3">
            <div>
              <h2 class="text-xs font-semibold text-slate-900">
                Correction Queue
              </h2>
              <p class="text-[11px] text-slate-500">
                Pending corrections for this persona.
              </p>
            </div>
            <div class="space-y-2 text-[11px]">
              <div
                *ngFor="let corr of corrections"
                class="rounded-md border px-3 py-2"
                [ngClass]="{
                  'border-amber-100 bg-amber-50': corr.status === 'Open',
                  'border-emerald-100 bg-emerald-50': corr.status === 'Resolved'
                }"
              >
                <div class="flex items-center justify-between">
                  <span
                    class="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] font-semibold"
                    [ngClass]="{
                      'bg-amber-500 text-white': corr.status === 'Open',
                      'bg-emerald-500 text-white': corr.status === 'Resolved'
                    }"
                  >
                    {{ corr.status }}
                  </span>
                  <span class="text-[10px] text-slate-500">
                    {{ corr.date }}
                  </span>
                </div>
                <div class="mt-1 font-semibold text-slate-900">
                  {{ corr.title }}
                </div>
                <div class="text-[10px] text-slate-600">
                  Raised by: {{ corr.raisedBy }}
                </div>
              </div>
              <div *ngIf="corrections.length === 0" class="text-[11px] text-slate-500">
                No corrections pending for this persona.
              </div>
            </div>
          </div>
        </section>
      </div>
    </section>

    <section class="flex flex-col gap-3 rounded-xl border border-blue-100 bg-white px-6 py-3 shadow-sm md:flex-row md:items-center md:justify-between">
      <button
        type="button"
        class="inline-flex h-9 items-center justify-center rounded-md border border-slate-200 bg-white px-4 text-[11px] font-semibold text-slate-700 shadow-sm hover:bg-slate-50"
        (click)="onPrintDetails()"
      >
        Print Details
      </button>
      <button
        type="button"
        class="inline-flex h-9 items-center justify-center rounded-md bg-blue-600 px-6 text-[11px] font-semibold text-white shadow-sm hover:bg-blue-700"
        (click)="onBackToList()"
      >
        Return to Bulk CIB List
      </button>
    </section>
  </div>
</app-loms-layout>
