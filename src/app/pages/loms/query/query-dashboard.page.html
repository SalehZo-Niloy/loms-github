<app-loms-layout
  organisationName="Loan Origination and Management System"
  solutionName="LOMS"
  breadcrumb="Query Management"
  basePath="/loms"
>
  <div class="px-2 py-4 bg-slate-50 min-h-screen space-y-6 w-full flex-1 max-w-screen-2xl mx-auto">
    <section class="flex items-center justify-between">
      <h1 class="text-2xl font-semibold text-slate-900">
        LOMS Query Management
      </h1>
      <div class="flex items-center gap-3">
        <input
          type="text"
          class="hidden md:block w-72 rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-800 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-300"
          [(ngModel)]="searchTerm"
          placeholder="Search App No / Query ID / Customer..."
        />
        <button
          type="button"
          class="inline-flex items-center justify-center rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700"
          (click)="openCreateQuery()"
        >
          + New Query
        </button>
        <div class="flex items-center gap-2 text-sm">
          <span class="text-slate-600">Login as:</span>
          <select
            class="rounded-md border border-slate-300 bg-white px-2.5 py-1 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-300"
            [(ngModel)]="currentUserId"
            (ngModelChange)="onUserChange()"
          >
            <option *ngFor="let u of users" [ngValue]="u.id">
              {{ u.name }}
            </option>
          </select>
        </div>
      </div>
    </section>

    <section class="grid gap-4 md:grid-cols-3">
      <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
        <div class="text-xs font-semibold uppercase tracking-wide text-slate-500">
          My Open Queries
        </div>
        <div class="mt-2 text-3xl font-semibold text-slate-900">
          {{ myOpenCount }}
        </div>
      </div>
      <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
        <div class="text-xs font-semibold uppercase tracking-wide text-slate-500">
          Waiting My Response
        </div>
        <div class="mt-2 text-3xl font-semibold text-slate-900">
          {{ waitingMyResponseCount }}
        </div>
      </div>
      <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
        <div class="text-xs font-semibold uppercase tracking-wide text-slate-500">
          SLA Breached (All)
        </div>
        <div class="mt-2 text-3xl font-semibold text-red-600">
          {{ slaBreachedCount }}
        </div>
      </div>
    </section>

    <section class="space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-sm font-semibold text-slate-800">
          My Inbox (Top 8)
        </h2>
      </div>
      <div class="rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden">
        <table class="min-w-full border-collapse text-sm">
          <thead class="bg-slate-50">
            <tr class="text-left text-xs font-semibold text-slate-600">
              <th class="px-4 py-2">ID</th>
              <th class="px-4 py-2">Title</th>
              <th class="px-4 py-2">Priority</th>
              <th class="px-4 py-2">Status</th>
              <th class="px-4 py-2">Due</th>
            </tr>
          </thead>
          <tbody>
            <tr
              *ngFor="let q of filteredInbox | slice:0:8"
              class="border-t border-slate-100 text-slate-800 hover:bg-slate-50 cursor-pointer"
              (click)="openQuery(q)"
            >
              <td class="px-4 py-2">
                {{ q.id }}
              </td>
              <td class="px-4 py-2">
                {{ q.title }}
              </td>
              <td class="px-4 py-2">
                <span
                  class="inline-flex items-center rounded-full px-3 py-1 text-[11px] font-semibold"
                  [ngClass]="getPriorityBadgeClasses(q.priority)"
                >
                  {{ q.priority }}
                </span>
              </td>
              <td class="px-4 py-2">
                {{ q.status }}
              </td>
              <td class="px-4 py-2">
                {{ q.dueAt | date: 'M/d/yyyy, h:mm a' }}
              </td>
            </tr>
            <tr *ngIf="filteredInbox.length === 0">
              <td class="px-4 py-4 text-center text-sm text-slate-500" colspan="5">
                No queries for this user yet.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <div
      *ngIf="drawerOpen && selectedQuery"
      class="fixed inset-0 z-40 flex justify-end bg-black/40"
    >
      <div class="flex h-full w-full max-w-5xl bg-white shadow-xl">
        <div class="w-1/3 border-r border-slate-200 p-4 space-y-3">
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-slate-900">
              Query #{{ selectedQuery.id }}
            </h2>
            <button
              type="button"
              class="rounded-md border border-slate-300 px-2 py-1 text-xs"
              (click)="closeDrawer()"
            >
              ✕
            </button>
          </div>
          <div class="flex items-center gap-2 text-xs">
            <span
              class="inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-semibold bg-emerald-50 text-emerald-700"
            >
              {{ selectedQuery.status }}
            </span>
            <span
              class="inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-semibold"
              [ngClass]="getPriorityBadgeClasses(selectedQuery.priority)"
            >
              {{ selectedQuery.priority }}
            </span>
          </div>
          <div class="text-xs space-y-1">
            <div>
              <span class="font-semibold text-slate-700">App No:</span>
              <span class="ml-1 text-slate-800">
                {{ selectedQuery.loanApp?.appNo }}
              </span>
            </div>
            <div>
              <span class="font-semibold text-slate-700">Customer:</span>
              <span class="ml-1 text-slate-800">
                {{ selectedQuery.loanApp?.customerName }}
              </span>
            </div>
            <div>
              <span class="font-semibold text-slate-700">Product:</span>
              <span class="ml-1 text-slate-800">
                {{ selectedQuery.loanApp?.product }}
              </span>
            </div>
            <div>
              <span class="font-semibold text-slate-700">Due:</span>
              <span class="ml-1 text-slate-800">
                {{ selectedQuery.dueAt | date: 'M/d/yyyy, h:mm a' }}
              </span>
            </div>
            <div class="mt-2 border-t border-slate-200"></div>
            <div class="pt-1">
              <span class="font-semibold text-slate-700">Recipients:</span>
              <span class="ml-1 text-slate-800">
                <ng-container *ngIf="selectedRecipients.length; else noRecipients">
                  <span
                    *ngFor="let r of selectedRecipients; let last = last"
                  >
                    {{ r.name }}<span *ngIf="!last">, </span>
                  </span>
                </ng-container>
                <ng-template #noRecipients>—</ng-template>
              </span>
            </div>
            <div
              class="pt-3"
              *ngIf="
                selectedQuery &&
                selectedQuery.status !== 'Closed' &&
                selectedQuery.recipientIds.includes(currentUserId)
              "
            >
              <button
                type="button"
                class="inline-flex items-center rounded-md bg-emerald-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-emerald-700"
                (click)="closeSelectedQuery()"
              >
                Close Query
              </button>
            </div>
          </div>
        </div>

        <div class="flex-1 border-r border-slate-200 flex flex-col">
          <div class="flex-1 overflow-y-auto p-4 space-y-3">
            <div
              *ngFor="let m of selectedMessages"
              class="flex flex-col items-start text-xs"
            >
              <div
                class="max-w-xs rounded-lg px-3 py-2"
                [ngClass]="
                  m.role === 'QUESTION'
                    ? 'bg-blue-50 text-slate-900'
                    : 'bg-slate-100 text-slate-900'
                "
              >
                <div class="mb-1 text-[11px] font-semibold text-slate-600">
                  {{ m.senderLabel }}
                  <span class="ml-1 text-[10px] text-slate-400">
                    {{ m.createdAt | date: 'M/d/yyyy, h:mm a' }}
                  </span>
                </div>
                <div class="text-xs">
                  {{ m.text }}
                </div>
              </div>
            </div>
          </div>
          <div class="border-t border-slate-200 p-4 space-y-2">
            <textarea
              rows="3"
              class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm text-slate-800 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-300"
              [(ngModel)]="responseText"
              placeholder="Type a response..."
            ></textarea>
            <div class="flex items-center justify-between">
              <div class="flex flex-col items-start gap-1">
                <input
                  #fileInput
                  type="file"
                  class="hidden"
                  multiple
                  (change)="onUploadDocument($event)"
                />
                <button
                  type="button"
                  class="inline-flex items-center gap-1 rounded-md border border-slate-300 px-3 py-1.5 text-xs font-medium text-slate-800 hover:bg-slate-50/40"
                  (click)="fileInput.click()"
                >
                  <svg
                    class="h-4 w-4 text-slate-700"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M12 3v12m0-12 4 4m-4-4-4 4M5 17h14"
                      stroke="currentColor"
                      stroke-width="1.5"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                  <span>Upload document</span>
                </button>
                <div *ngIf="uploadedFiles.length" class="text-[11px] text-slate-500">
                  <div *ngFor="let f of uploadedFiles">
                    {{ f }}
                  </div>
                </div>
              </div>
              <button
                type="button"
                class="rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700"
                (click)="sendResponse()"
              >
                Send Response
              </button>
            </div>
          </div>
        </div>

        <div class="w-1/4 p-4 space-y-3">
          <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">
            Activity Log
          </h3>
          <div class="space-y-2 text-xs text-slate-700">
            <div *ngFor="let m of selectedMessages">
              <div class="text-[11px] text-slate-500">
                {{ m.createdAt | date: 'M/d/yyyy, h:mm a' }}
              </div>
              <div>
                {{ m.senderLabel }}:
                <span class="text-slate-600">{{ m.text }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</app-loms-layout>
