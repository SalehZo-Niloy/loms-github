<app-loms-layout organisationName="Loan Origination and Management System" solutionName="LOMS" breadcrumb="Dashboard"
  basePath="/loms">
  <div class="w-full min-h-full space-y-4 bg-white px-3 py-3 sm:px-4 sm:py-4 lg:px-6 lg:py-6 overflow-x-hidden">
    <section class="space-y-4">
      <div class="flex flex-col gap-3 min-w-0">
        <!-- Stats + charts -->
        <div class="grid gap-3 grid-cols-1 sm:grid-cols-2 xl:grid-cols-4">
          <div class="rounded-md border border-slate-200 bg-white px-4 py-3">
            <div class="text-[11px] font-semibold uppercase text-slate-500">
              Total Applications
            </div>
            <div class="mt-1 text-lg font-semibold text-blue-700">
              {{ stats.totalTransactions }}
            </div>
          </div>

          <div class="rounded-md border border-slate-200 bg-white px-4 py-3">
            <div class="text-[11px] font-semibold uppercase text-slate-500">
              Pending Action
            </div>
            <div class="mt-1 text-lg font-semibold text-blue-700">
              {{ stats.pendingAction }}
            </div>
          </div>

          <div class="rounded-md border border-slate-200 bg-white px-4 py-3">
            <div class="text-[11px] font-semibold uppercase text-slate-500">
              Completed
            </div>
            <div class="mt-1 text-lg font-semibold text-blue-700">
              {{ stats.completed }}
            </div>
          </div>

          <div class="rounded-md border border-slate-200 bg-white px-4 py-3">
            <div class="text-[11px] font-semibold uppercase text-slate-500">
              Rejected / Returned
            </div>
            <div class="mt-1 text-lg font-semibold text-blue-700">
              {{ stats.rejected }}
            </div>
          </div>

          <!-- charts blocks are unchanged (commented) -->
        </div>

        <!-- Azure-style search + filters bar -->
        <div class="mt-2 rounded-md border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-700 relative"
          (click)="$event.stopPropagation()">
          <div class="flex flex-col sm:flex-row sm:items-center gap-3 min-w-0">
            <!-- Search -->
            <div class="flex flex-1 items-center gap-2 min-w-0">
              <span class="text-slate-400 shrink-0">
                <span class="inline-block h-[10px] w-[10px] rounded-full border border-slate-400"></span>
              </span>
              <input type="text"
                class="w-full min-w-0 bg-transparent px-1 py-1 text-xs text-slate-800 placeholder:text-slate-400 focus:outline-none"
                [(ngModel)]="searchTerm" (ngModelChange)="onSearchChange()" placeholder="Filter by keyword" />
            </div>

            <!-- Inline dropdown filters -->
            <div class="flex items-center gap-2 min-w-0">
              <div class="relative flex flex-wrap items-center gap-2 ml-0 sm:ml-1 min-w-0">
                <!-- View dropdown -->
                <div class="relative">
                  <button type="button"
                    class="inline-flex items-center rounded-md border border-slate-300 bg-white px-2.5 py-1 text-[11px] font-medium text-slate-700 hover:bg-slate-50"
                    (click)="toggleViewDropdown()">
                    <span class="mr-1">
                      {{ selectedViewLabel }}
                    </span>
                    <span class="text-[10px] text-slate-400">▾</span>
                  </button>
                  <div *ngIf="openViewDropdown"
                    class="absolute right-0 top-full z-40 w-40 rounded-md border border-slate-200 bg-white py-1 text-[11px] shadow-lg">
                    <button type="button" *ngFor="let v of views"
                      class="flex w-full items-center justify-between px-3 py-1.5 text-left hover:bg-blue-50"
                      (click)="onViewChange(v.key)">
                      <span>{{ v.label }}</span>
                    </button>
                  </div>
                </div>

                <!-- Assignee dropdown -->
                <div class="relative">
                  <button type="button"
                    class="inline-flex items-center rounded-md border border-slate-300 bg-white px-2.5 py-1 text-[11px] font-medium text-slate-700 hover:bg-slate-50"
                    (click)="toggleAssigneeDropdown()">
                    <span class="mr-1">
                      {{ assigneeSelectedLabel }}
                    </span>
                    <span class="text-[10px] text-slate-400">▾</span>
                  </button>
                  <div *ngIf="openAssigneeDropdown"
                    class="absolute right-0 top-full z-40 w-40 rounded-md border border-slate-200 bg-white py-1 text-[11px] shadow-lg">
                    <button type="button" *ngFor="let option of assigneeFilterOptions"
                      class="flex w-full items-center justify-between px-3 py-1.5 text-left hover:bg-blue-50"
                      (click)="onAssigneeQuickFilterChange(option.key)">
                      <span>{{ option.label }}</span>
                    </button>
                  </div>
                </div>

                <button type="button"
                  class="inline-flex items-center rounded-md border border-slate-300 bg-white px-2.5 py-1 text-[11px] font-medium text-slate-700 hover:bg-slate-50"
                  (click)="showOptionsPanel = !showOptionsPanel">
                  <span class="mr-1">Options</span>
                  <span class="text-xs">▾</span>
                </button>

                <button type="button"
                  class="inline-flex items-center justify-center rounded-md border border-slate-300 bg-white px-2.5 py-1 text-[11px] font-medium text-slate-600 hover:bg-slate-50"
                  (click)="clearAllFilters()">
                  Reset
                </button>

                <!-- Options panel -->
                <div *ngIf="showOptionsPanel"
                  class="absolute right-0 top-full z-20 mt-2 w-72 max-w-[calc(100vw-1.5rem)] rounded-md border border-slate-200 bg-white p-3 text-[11px] shadow-lg">
                  <div class="mb-2 flex items-center justify-between">
                    <div class="font-semibold text-slate-800">
                      Display options
                    </div>
                    <button type="button" class="text-slate-400 hover:text-slate-600"
                      (click)="showOptionsPanel = false">
                      ×
                    </button>
                  </div>

                  <div class="mb-3">
                    <div class="mb-1 text-[10px] font-semibold uppercase text-slate-500">
                      Columns
                    </div>
                    <div class="space-y-1">
                      <label *ngFor="let col of columnConfigs" class="flex items-center justify-between gap-2">
                        <div class="flex items-center gap-2">
                          <input type="checkbox"
                            class="h-3.5 w-3.5 rounded border-slate-300 text-blue-600 focus:ring-blue-200"
                            [checked]="isColumnVisible(col.key)" (change)="toggleColumnVisibility(col.key)" />
                          <span class="text-[11px] text-slate-700">
                            {{ col.label }}
                          </span>
                        </div>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Table -->
        <div class="w-full min-w-0">
          <div class="w-full rounded-md border border-slate-200 bg-white overflow-hidden">
            <!-- horizontal scroll lives here (only table scrolls, not page) -->
            <div class="w-full overflow-x-auto">
              <div class="w-full min-w-0">
                <!-- HEADER (hide on very small screens, because rows become stacked) -->
                <div class="hidden sm:grid gap-3 border-b border-slate-100 px-4 py-2 text-[11px] font-semibold uppercase text-slate-500
                            grid-cols-2 sm:grid-cols-6 lg:grid-cols-11">
                  <!-- APP ID -->
                  <div *ngIf="isColumnVisible('appId')" class="relative col-span-1" (click)="$event.stopPropagation()">
                    <button type="button" cdkOverlayOrigin #appIdOrigin="cdkOverlayOrigin"
                      class="inline-flex items-center rounded-md border border-transparent px-2 py-1 text-[11px] font-semibold uppercase tracking-[0.04em] text-slate-500 hover:bg-white hover:border-slate-300 hover:text-slate-800"
                      (click)="toggleHeaderDropdown('appId'); $event.stopPropagation()">
                      <span class="mr-1">App ID</span>

                      <span *ngIf="getSortDirectionFor('appId') === 'asc'" class="text-[9px] text-slate-400">▲</span>
                      <span *ngIf="getSortDirectionFor('appId') === 'desc'" class="text-[9px] text-slate-400">▼</span>
                      <span *ngIf="!getSortDirectionFor('appId')" class="text-[9px] text-slate-300">▾</span>
                    </button>

                    <ng-template cdkConnectedOverlay [cdkConnectedOverlayOrigin]="appIdOrigin"
                      [cdkConnectedOverlayOpen]="openHeaderDropdownKey === 'appId'"
                      [cdkConnectedOverlayHasBackdrop]="true"
                      cdkConnectedOverlayBackdropClass="cdk-overlay-transparent-backdrop"
                      (backdropClick)="closeHeaderDropdown()" (detach)="closeHeaderDropdown()"
                      [cdkConnectedOverlayOffsetY]="6" [cdkConnectedOverlayPositions]="overlayPositions">
                      <div class="z-[9999] w-44 rounded-md border border-slate-200 bg-white py-1 text-[11px] shadow-lg">
                        <div class="px-3 pb-1 pt-1 text-[10px] font-semibold uppercase text-slate-400">Sort</div>
                        <div class="px-3 pb-2 space-y-1">
                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-appId" [checked]="!getSortDirectionFor('appId')"
                              (change)="onHeaderSortOptionClick('appId', 'default')" />
                            <span class="text-[11px] text-slate-700">Default</span>
                          </label>

                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-appId" [checked]="getSortDirectionFor('appId') === 'asc'"
                              (change)="onHeaderSortOptionClick('appId', 'asc')" />
                            <span class="text-[11px] text-slate-700">Ascending</span>
                          </label>

                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-appId" [checked]="getSortDirectionFor('appId') === 'desc'"
                              (change)="onHeaderSortOptionClick('appId', 'desc')" />
                            <span class="text-[11px] text-slate-700">Descending</span>
                          </label>
                        </div>
                      </div>
                    </ng-template>
                  </div>

                  <!-- PRODUCT -->
                  <div *ngIf="isColumnVisible('product')" class="relative col-span-1 lg:col-span-2" (click)="$event.stopPropagation()">
                    <button type="button" cdkOverlayOrigin #productOrigin="cdkOverlayOrigin"
                      class="inline-flex items-center rounded-md border border-transparent px-2 py-1 text-[11px] font-semibold uppercase tracking-[0.04em] text-slate-500 hover:bg-white hover:border-slate-300 hover:text-slate-800"
                      (click)="toggleHeaderDropdown('product'); $event.stopPropagation()">
                      <span class="mr-1">Product</span>

                      <span *ngIf="getSortDirectionFor('product') === 'asc'" class="text-[9px] text-slate-400">▲</span>
                      <span *ngIf="getSortDirectionFor('product') === 'desc'" class="text-[9px] text-slate-400">▼</span>
                      <span *ngIf="!getSortDirectionFor('product')" class="text-[9px] text-slate-300">▾</span>
                    </button>

                    <ng-template cdkConnectedOverlay [cdkConnectedOverlayOrigin]="productOrigin"
                      [cdkConnectedOverlayOpen]="openHeaderDropdownKey === 'product'"
                      [cdkConnectedOverlayHasBackdrop]="true"
                      cdkConnectedOverlayBackdropClass="cdk-overlay-transparent-backdrop"
                      (backdropClick)="closeHeaderDropdown()" (detach)="closeHeaderDropdown()"
                      [cdkConnectedOverlayOffsetY]="6" [cdkConnectedOverlayPositions]="overlayPositions">
                      <div class="z-[9999] w-56 rounded-md border border-slate-200 bg-white py-1 text-[11px] shadow-lg">
                        <!-- unchanged dropdown content -->
                        <div class="px-3 pb-1 pt-1 text-[10px] font-semibold uppercase text-slate-400">Sort</div>
                        <div class="px-3 pb-2 space-y-1">
                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-product" [checked]="!getSortDirectionFor('product')"
                              (change)="onHeaderSortOptionClick('product', 'default')" />
                            <span class="text-[11px] text-slate-700">Default</span>
                          </label>
                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-product" [checked]="getSortDirectionFor('product') === 'asc'"
                              (change)="onHeaderSortOptionClick('product', 'asc')" />
                            <span class="text-[11px] text-slate-700">Ascending</span>
                          </label>
                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-product" [checked]="getSortDirectionFor('product') === 'desc'"
                              (change)="onHeaderSortOptionClick('product', 'desc')" />
                            <span class="text-[11px] text-slate-700">Descending</span>
                          </label>
                        </div>

                        <div class="mt-2 px-3 pb-1 pt-1 text-[10px] font-semibold uppercase text-slate-400">Product</div>
                        <div class="max-h-40 overflow-y-auto px-3 pb-2 space-y-1">
                          <label *ngFor="let option of productFilterOptions" class="flex items-center justify-between gap-2">
                            <div class="flex items-center gap-2">
                              <input type="checkbox"
                                class="h-3.5 w-3.5 rounded border-slate-300 text-blue-600 focus:ring-blue-200"
                                [checked]="option.selected" (change)="toggleFilterOption('product', option.key)" />
                              <span class="text-slate-700">{{ option.label }}</span>
                            </div>
                            <span class="text-[10px] text-slate-400">{{ option.count }}</span>
                          </label>
                        </div>

                        <div class="px-3 pb-1 pt-1 text-[10px] font-semibold uppercase text-slate-400">Product Name</div>
                        <div class="max-h-40 overflow-y-auto px-3 pb-2 space-y-1">
                          <label *ngFor="let option of productNameFilterOptions" class="flex items-center justify-between gap-2">
                            <div class="flex items-center gap-2">
                              <input type="checkbox"
                                class="h-3.5 w-3.5 rounded border-slate-300 text-blue-600 focus:ring-blue-200"
                                [checked]="option.selected"
                                (change)="toggleFilterOption('productName', option.key)" />
                              <span class="text-slate-700">{{ option.label }}</span>
                            </div>
                            <span class="text-[10px] text-slate-400">{{ option.count }}</span>
                          </label>
                        </div>
                      </div>
                    </ng-template>
                  </div>

                  <!-- STATUS -->
                  <div *ngIf="isColumnVisible('status')" class="relative col-span-1" (click)="$event.stopPropagation()">
                    <!-- unchanged button + dropdown -->
                    <button type="button" cdkOverlayOrigin #statusOrigin="cdkOverlayOrigin"
                      class="inline-flex items-center rounded-md border border-transparent px-2 py-1 text-[11px] font-semibold uppercase tracking-[0.04em] text-slate-500 hover:bg-white hover:border-slate-300 hover:text-slate-800"
                      (click)="toggleHeaderDropdown('status'); $event.stopPropagation()">
                      <span class="mr-1">Status</span>
                      <span *ngIf="getSortDirectionFor('status') === 'asc'" class="text-[9px] text-slate-400">▲</span>
                      <span *ngIf="getSortDirectionFor('status') === 'desc'" class="text-[9px] text-slate-400">▼</span>
                      <span *ngIf="!getSortDirectionFor('status')" class="text-[9px] text-slate-300">▾</span>
                    </button>

                    <ng-template cdkConnectedOverlay [cdkConnectedOverlayOrigin]="statusOrigin"
                      [cdkConnectedOverlayOpen]="openHeaderDropdownKey === 'status'"
                      [cdkConnectedOverlayHasBackdrop]="true"
                      cdkConnectedOverlayBackdropClass="cdk-overlay-transparent-backdrop"
                      (backdropClick)="closeHeaderDropdown()" (detach)="closeHeaderDropdown()"
                      [cdkConnectedOverlayOffsetY]="6" [cdkConnectedOverlayPositions]="overlayPositions">
                      <div class="z-[9999] w-56 rounded-md border border-slate-200 bg-white py-1 text-[11px] shadow-lg">
                        <!-- unchanged dropdown content -->
                        <div class="px-3 pb-1 pt-1 text-[10px] font-semibold uppercase text-slate-400">Sort</div>
                        <div class="px-3 pb-2 space-y-1">
                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-status" [checked]="!getSortDirectionFor('status')"
                              (change)="onHeaderSortOptionClick('status', 'default')" />
                            <span class="text-[11px] text-slate-700">Default</span>
                          </label>
                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-status" [checked]="getSortDirectionFor('status') === 'asc'"
                              (change)="onHeaderSortOptionClick('status', 'asc')" />
                            <span class="text-[11px] text-slate-700">Ascending</span>
                          </label>
                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-status" [checked]="getSortDirectionFor('status') === 'desc'"
                              (change)="onHeaderSortOptionClick('status', 'desc')" />
                            <span class="text-[11px] text-slate-700">Descending</span>
                          </label>
                        </div>

                        <div class="mt-2 px-3 pb-1 pt-1 text-[10px] font-semibold uppercase text-slate-400">Status</div>
                        <div class="max-h-40 overflow-y-auto px-3 pb-2 space-y-1">
                          <label *ngFor="let option of statusFilterOptions" class="flex items-center justify-between gap-2">
                            <div class="flex items-center gap-2">
                              <input type="checkbox"
                                class="h-3.5 w-3.5 rounded border-slate-300 text-blue-600 focus:ring-blue-200"
                                [checked]="option.selected" (change)="toggleFilterOption('status', option.key)" />
                              <span class="text-slate-700">{{ option.label }}</span>
                            </div>
                            <span class="text-[10px] text-slate-400">{{ option.count }}</span>
                          </label>
                        </div>
                      </div>
                    </ng-template>
                  </div>

                  <!-- CUSTOMER -->
                  <div *ngIf="isColumnVisible('customer')" class="relative col-span-1 lg:col-span-2" (click)="$event.stopPropagation()">
                    <!-- unchanged customer sort dropdown -->
                    <button type="button" cdkOverlayOrigin #customerOrigin="cdkOverlayOrigin"
                      class="inline-flex items-center rounded-md border border-transparent px-2 py-1 text-[11px] font-semibold uppercase tracking-[0.04em] text-slate-500 hover:bg-white hover:border-slate-300 hover:text-slate-800"
                      (click)="toggleHeaderDropdown('customer'); $event.stopPropagation()">
                      <span class="mr-1">Customer</span>
                      <span *ngIf="getSortDirectionFor('customer') === 'asc'" class="text-[9px] text-slate-400">▲</span>
                      <span *ngIf="getSortDirectionFor('customer') === 'desc'" class="text-[9px] text-slate-400">▼</span>
                      <span *ngIf="!getSortDirectionFor('customer')" class="text-[9px] text-slate-300">▾</span>
                    </button>
                    <ng-template cdkConnectedOverlay [cdkConnectedOverlayOrigin]="customerOrigin"
                      [cdkConnectedOverlayOpen]="openHeaderDropdownKey === 'customer'"
                      [cdkConnectedOverlayHasBackdrop]="true"
                      cdkConnectedOverlayBackdropClass="cdk-overlay-transparent-backdrop"
                      (backdropClick)="closeHeaderDropdown()" (detach)="closeHeaderDropdown()"
                      [cdkConnectedOverlayOffsetY]="6" [cdkConnectedOverlayPositions]="overlayPositions">
                      <div class="z-[9999] w-44 rounded-md border border-slate-200 bg-white py-1 text-[11px] shadow-lg">
                        <div class="px-3 pb-1 pt-1 text-[10px] font-semibold uppercase text-slate-400">Sort</div>
                        <div class="px-3 pb-2 space-y-1">
                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-customer" [checked]="!getSortDirectionFor('customer')"
                              (change)="onHeaderSortOptionClick('customer', 'default')" />
                            <span class="text-[11px] text-slate-700">Default</span>
                          </label>
                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-customer" [checked]="getSortDirectionFor('customer') === 'asc'"
                              (change)="onHeaderSortOptionClick('customer', 'asc')" />
                            <span class="text-[11px] text-slate-700">Ascending</span>
                          </label>
                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-customer" [checked]="getSortDirectionFor('customer') === 'desc'"
                              (change)="onHeaderSortOptionClick('customer', 'desc')" />
                            <span class="text-[11px] text-slate-700">Descending</span>
                          </label>
                        </div>
                      </div>
                    </ng-template>
                  </div>

                  <!-- DATE -->
                  <div *ngIf="isColumnVisible('date')" class="relative col-span-1 lg:col-span-2" (click)="$event.stopPropagation()">
                    <!-- unchanged date sort dropdown -->
                    <button type="button" cdkOverlayOrigin #dateOrigin="cdkOverlayOrigin"
                      class="inline-flex items-center rounded-md border border-transparent px-2 py-1 text-[11px] font-semibold uppercase tracking-[0.04em] text-slate-500 hover:bg-white hover:border-slate-300 hover:text-slate-800"
                      (click)="toggleHeaderDropdown('date'); $event.stopPropagation()">
                      <span class="mr-1">Date</span>
                      <span *ngIf="getSortDirectionFor('date') === 'asc'" class="text-[9px] text-slate-400">▲</span>
                      <span *ngIf="getSortDirectionFor('date') === 'desc'" class="text-[9px] text-slate-400">▼</span>
                      <span *ngIf="!getSortDirectionFor('date')" class="text-[9px] text-slate-300">▾</span>
                    </button>
                    <ng-template cdkConnectedOverlay [cdkConnectedOverlayOrigin]="dateOrigin"
                      [cdkConnectedOverlayOpen]="openHeaderDropdownKey === 'date'"
                      [cdkConnectedOverlayHasBackdrop]="true"
                      cdkConnectedOverlayBackdropClass="cdk-overlay-transparent-backdrop"
                      (backdropClick)="closeHeaderDropdown()" (detach)="closeHeaderDropdown()"
                      [cdkConnectedOverlayOffsetY]="6" [cdkConnectedOverlayPositions]="overlayPositions">
                      <div class="z-[9999] w-44 rounded-md border border-slate-200 bg-white py-1 text-[11px] shadow-lg">
                        <div class="px-3 pb-1 pt-1 text-[10px] font-semibold uppercase text-slate-400">Sort</div>
                        <div class="px-3 pb-2 space-y-1">
                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-date" [checked]="!getSortDirectionFor('date')"
                              (change)="onHeaderSortOptionClick('date', 'default')" />
                            <span class="text-[11px] text-slate-700">Default</span>
                          </label>
                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-date" [checked]="getSortDirectionFor('date') === 'asc'"
                              (change)="onHeaderSortOptionClick('date', 'asc')" />
                            <span class="text-[11px] text-slate-700">Ascending</span>
                          </label>
                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-date" [checked]="getSortDirectionFor('date') === 'desc'"
                              (change)="onHeaderSortOptionClick('date', 'desc')" />
                            <span class="text-[11px] text-slate-700">Descending</span>
                          </label>
                        </div>
                      </div>
                    </ng-template>
                  </div>

                  <!-- SOURCE -->
                  <div *ngIf="isColumnVisible('source')" class="relative hidden lg:block col-span-1" (click)="$event.stopPropagation()">
                    <!-- unchanged source sort dropdown -->
                    <button type="button" cdkOverlayOrigin #sourceOrigin="cdkOverlayOrigin"
                      class="inline-flex items-center rounded-md border border-transparent px-2 py-1 text-[11px] font-semibold uppercase tracking-[0.04em] text-slate-500 hover:bg-white hover:border-slate-300 hover:text-slate-800"
                      (click)="toggleHeaderDropdown('source'); $event.stopPropagation()">
                      <span class="mr-1">Source</span>
                      <span *ngIf="getSortDirectionFor('source') === 'asc'" class="text-[9px] text-slate-400">▲</span>
                      <span *ngIf="getSortDirectionFor('source') === 'desc'" class="text-[9px] text-slate-400">▼</span>
                      <span *ngIf="!getSortDirectionFor('source')" class="text-[9px] text-slate-300">▾</span>
                    </button>
                    <ng-template cdkConnectedOverlay [cdkConnectedOverlayOrigin]="sourceOrigin"
                      [cdkConnectedOverlayOpen]="openHeaderDropdownKey === 'source'"
                      [cdkConnectedOverlayHasBackdrop]="true"
                      cdkConnectedOverlayBackdropClass="cdk-overlay-transparent-backdrop"
                      (backdropClick)="closeHeaderDropdown()" (detach)="closeHeaderDropdown()"
                      [cdkConnectedOverlayOffsetY]="6" [cdkConnectedOverlayPositions]="overlayPositions">
                      <div class="z-[9999] w-44 rounded-md border border-slate-200 bg-white py-1 text-[11px] shadow-lg">
                        <div class="px-3 pb-1 pt-1 text-[10px] font-semibold uppercase text-slate-400">Sort</div>
                        <div class="px-3 pb-2 space-y-1">
                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-source" [checked]="!getSortDirectionFor('source')"
                              (change)="onHeaderSortOptionClick('source', 'default')" />
                            <span class="text-[11px] text-slate-700">Default</span>
                          </label>
                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-source" [checked]="getSortDirectionFor('source') === 'asc'"
                              (change)="onHeaderSortOptionClick('source', 'asc')" />
                            <span class="text-[11px] text-slate-700">Ascending</span>
                          </label>
                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-source" [checked]="getSortDirectionFor('source') === 'desc'"
                              (change)="onHeaderSortOptionClick('source', 'desc')" />
                            <span class="text-[11px] text-slate-700">Descending</span>
                          </label>
                        </div>
                      </div>
                    </ng-template>
                  </div>

                  <!-- ROLE -->
                  <div *ngIf="isColumnVisible('role')" class="relative hidden lg:block col-span-1" (click)="$event.stopPropagation()">
                    <!-- unchanged role sort dropdown -->
                    <button type="button" cdkOverlayOrigin #roleOrigin="cdkOverlayOrigin"
                      class="inline-flex items-center rounded-md border border-transparent px-2 py-1 text-[11px] font-semibold uppercase tracking-[0.04em] text-slate-500 hover:bg-white hover:border-slate-300 hover:text-slate-800"
                      (click)="toggleHeaderDropdown('role'); $event.stopPropagation()">
                      <span class="mr-1">Role</span>
                      <span *ngIf="getSortDirectionFor('role') === 'asc'" class="text-[9px] text-slate-400">▲</span>
                      <span *ngIf="getSortDirectionFor('role') === 'desc'" class="text-[9px] text-slate-400">▼</span>
                      <span *ngIf="!getSortDirectionFor('role')" class="text-[9px] text-slate-300">▾</span>
                    </button>
                    <ng-template cdkConnectedOverlay [cdkConnectedOverlayOrigin]="roleOrigin"
                      [cdkConnectedOverlayOpen]="openHeaderDropdownKey === 'role'"
                      [cdkConnectedOverlayHasBackdrop]="true"
                      cdkConnectedOverlayBackdropClass="cdk-overlay-transparent-backdrop"
                      (backdropClick)="closeHeaderDropdown()" (detach)="closeHeaderDropdown()"
                      [cdkConnectedOverlayOffsetY]="6" [cdkConnectedOverlayPositions]="overlayPositions">
                      <div class="z-[9999] w-44 rounded-md border border-slate-200 bg-white py-1 text-[11px] shadow-lg">
                        <div class="px-3 pb-1 pt-1 text-[10px] font-semibold uppercase text-slate-400">Sort</div>
                        <div class="px-3 pb-2 space-y-1">
                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-role" [checked]="!getSortDirectionFor('role')"
                              (change)="onHeaderSortOptionClick('role', 'default')" />
                            <span class="text-[11px] text-slate-700">Default</span>
                          </label>
                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-role" [checked]="getSortDirectionFor('role') === 'asc'"
                              (change)="onHeaderSortOptionClick('role', 'asc')" />
                            <span class="text-[11px] text-slate-700">Ascending</span>
                          </label>
                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-role" [checked]="getSortDirectionFor('role') === 'desc'"
                              (change)="onHeaderSortOptionClick('role', 'desc')" />
                            <span class="text-[11px] text-slate-700">Descending</span>
                          </label>
                        </div>
                      </div>
                    </ng-template>
                  </div>

                  <!-- AMOUNT -->
                  <div *ngIf="isColumnVisible('amount')" class="relative col-span-1" (click)="$event.stopPropagation()">
                    <!-- unchanged amount sort dropdown -->
                    <button type="button" cdkOverlayOrigin #amountOrigin="cdkOverlayOrigin"
                      class="inline-flex items-center rounded-md border border-transparent px-2 py-1 text-[11px] font-semibold uppercase tracking-[0.04em] text-slate-500 hover:bg-white hover:border-slate-300 hover:text-slate-800"
                      (click)="toggleHeaderDropdown('amount'); $event.stopPropagation()">
                      <span class="mr-1">Amount</span>
                      <span *ngIf="getSortDirectionFor('amount') === 'asc'" class="text-[9px] text-slate-400">▲</span>
                      <span *ngIf="getSortDirectionFor('amount') === 'desc'" class="text-[9px] text-slate-400">▼</span>
                      <span *ngIf="!getSortDirectionFor('amount')" class="text-[9px] text-slate-300">▾</span>
                    </button>
                    <ng-template cdkConnectedOverlay [cdkConnectedOverlayOrigin]="amountOrigin"
                      [cdkConnectedOverlayOpen]="openHeaderDropdownKey === 'amount'"
                      [cdkConnectedOverlayHasBackdrop]="true"
                      cdkConnectedOverlayBackdropClass="cdk-overlay-transparent-backdrop"
                      (backdropClick)="closeHeaderDropdown()" (detach)="closeHeaderDropdown()"
                      [cdkConnectedOverlayOffsetY]="6" [cdkConnectedOverlayPositions]="overlayPositions">
                      <div class="z-[9999] w-44 rounded-md border border-slate-200 bg-white py-1 text-[11px] shadow-lg">
                        <div class="px-3 pb-1 pt-1 text-[10px] font-semibold uppercase text-slate-400">Sort</div>
                        <div class="px-3 pb-2 space-y-1">
                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-amount" [checked]="!getSortDirectionFor('amount')"
                              (change)="onHeaderSortOptionClick('amount', 'default')" />
                            <span class="text-[11px] text-slate-700">Default</span>
                          </label>
                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-amount" [checked]="getSortDirectionFor('amount') === 'asc'"
                              (change)="onHeaderSortOptionClick('amount', 'asc')" />
                            <span class="text-[11px] text-slate-700">Ascending</span>
                          </label>
                          <label class="flex items-center gap-2">
                            <input type="radio" class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-200"
                              name="sort-amount" [checked]="getSortDirectionFor('amount') === 'desc'"
                              (change)="onHeaderSortOptionClick('amount', 'desc')" />
                            <span class="text-[11px] text-slate-700">Descending</span>
                          </label>
                        </div>
                      </div>
                    </ng-template>
                  </div>
                </div>

                <!-- ROWS -->
                <ng-container *ngIf="filteredUnifiedRows.length; else emptyState">
                  <div *ngFor="let row of filteredUnifiedRows"
                    class="w-full border-t border-slate-100 text-left hover:bg-blue-50/40 focus:outline-none focus:bg-blue-50/60 cursor-pointer"
                    [ngClass]="{ 'bg-blue-50': selectedRow && selectedRow.id === row.id }" role="button" tabindex="0"
                    (click)="openDetails(row)" (keydown.enter)="openDetails(row)">

                    <div class="grid gap-3 px-4 py-3 text-xs items-start min-w-0
                                grid-cols-1 sm:grid-cols-2 lg:grid-cols-11">
                      <div *ngIf="isColumnVisible('appId')" class="min-w-0">
                        <div class="font-medium text-blue-700 truncate">{{ row.id }}</div>
                      </div>

                      <div *ngIf="isColumnVisible('product')" class="min-w-0 lg:col-span-2">
                        <div class="text-slate-800 truncate">{{ row.productCategory }}</div>
                        <div class="text-[11px] text-slate-500 truncate">{{ row.productName }}</div>
                      </div>

                      <div *ngIf="isColumnVisible('status')" class="min-w-0">
                        <span class="inline-flex rounded-full px-2 py-0.5 text-[11px]" [ngClass]="getStatusClass(row.statusKey)">
                          {{ row.statusDisplay }}
                        </span>
                      </div>

                      <div *ngIf="isColumnVisible('customer')" class="min-w-0 lg:col-span-2">
                        <div class="text-slate-800 truncate">{{ row.customerLabel }}</div>
                        <div class="text-[11px] text-slate-500 truncate">{{ row.customerId }}</div>
                      </div>

                      <div *ngIf="isColumnVisible('date')" class="min-w-0 lg:col-span-2">
                        <div class="text-slate-800">{{ row.date | date: 'd MMM yyyy' }}</div>
                        <div class="text-[11px] text-slate-500">Upd: {{ row.updatedDate | date: 'd MMM yyyy' }}</div>
                      </div>

                      <div *ngIf="isColumnVisible('source')" class="hidden lg:block min-w-0 text-slate-800">
                        {{ row.source }}
                      </div>

                      <div *ngIf="isColumnVisible('role')" class="hidden lg:block min-w-0">
                        <div class="text-slate-800 truncate">{{ row.assigneeRole }}</div>
                        <div class="text-[11px] text-slate-500 truncate">{{ row.assigneeName }}</div>
                      </div>

                      <div *ngIf="isColumnVisible('amount')" class="min-w-0 text-slate-800 lg:text-right">
                        {{ row.amount | currency: row.currency:'symbol':'1.0-0' }}
                      </div>
                    </div>
                  </div>
                </ng-container>

                <ng-template #emptyState>
                  <div class="px-4 py-6 text-center text-xs text-slate-500">
                    No applications match your filters.
                  </div>
                </ng-template>
              </div>
            </div>
          </div>
        </div>

        <!-- Side modal (unchanged) -->
        <app-ui-side-modal [open]="!!selectedRow" size="md" (close)="closeDetails()">
          <ng-container *ngIf="selectedRow">
            <div class="flex h-full max-h-[100vh] flex-col border border-slate-200 bg-white rounded-l-md overflow-hidden">
              <div class="flex items-start justify-between px-4 py-3 border-b border-slate-100">
                <div>
                  <div class="text-sm font-semibold text-slate-900">
                    {{ selectedRow.id }}
                  </div>
                  <div class="mt-0.5 text-[11px] text-slate-500">
                    {{ selectedRow.productCategory }} - {{ selectedRow.productName }}
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <span class="inline-flex rounded-full px-2 py-0.5 text-[11px]"
                    [ngClass]="selectedRow && getStatusClass(selectedRow.statusKey)">
                    {{ selectedRow.statusDisplay }}
                  </span>
                  <button type="button" class="text-slate-400 hover:text-slate-600 text-lg leading-none"
                    (click)="closeDetails()">
                    ×
                  </button>
                </div>
              </div>

              <div class="px-4 py-3 border-b border-slate-100 flex items-center gap-2">
                <a class="inline-flex items-center justify-center rounded-md bg-blue-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-blue-700"
                  [routerLink]="selectedRow.link">
                  Open Full Case
                </a>
                <button type="button"
                  class="inline-flex items-center justify-center rounded-md border border-slate-200 bg-white px-3 py-1.5 text-xs font-medium text-slate-700">
                  Assign
                </button>
                <button type="button"
                  class="inline-flex items-center justify-center rounded-md border border-slate-200 bg-white px-3 py-1.5 text-xs font-medium text-slate-700">
                  Add Note
                </button>
              </div>

              <div class="px-4 border-b border-slate-100">
                <div class="flex items-center gap-4 text-xs">
                  <button type="button" class="py-2 border-b-2" [ngClass]="{
                      'border-blue-600 text-blue-700': activeDetailTab === 'summary',
                      'border-transparent text-slate-500': activeDetailTab !== 'summary'
                    }" (click)="setActiveDetailTab('summary')">
                    Summary
                  </button>
                  <button type="button" class="py-2 border-b-2" [ngClass]="{
                      'border-blue-600 text-blue-700': activeDetailTab === 'timeline',
                      'border-transparent text-slate-500': activeDetailTab !== 'timeline'
                    }" (click)="setActiveDetailTab('timeline')">
                    Timeline
                  </button>
                  <button type="button" class="py-2 border-b-2" [ngClass]="{
                      'border-blue-600 text-blue-700': activeDetailTab === 'flags',
                      'border-transparent text-slate-500': activeDetailTab !== 'flags'
                    }" (click)="setActiveDetailTab('flags')">
                    Flags
                  </button>
                </div>
              </div>

              <div class="flex-1 overflow-y-auto px-4 py-3 text-xs">
                <ng-container [ngSwitch]="activeDetailTab">
                  <div *ngSwitchCase="'summary'" class="space-y-3">
                    <div>
                      <div class="text-[11px] font-semibold text-slate-500">Customer</div>
                      <div class="mt-0.5 text-slate-800">
                        {{ selectedRow.customerLabel }} ({{ selectedRow.customerId }})
                      </div>
                    </div>

                    <div>
                      <div class="text-[11px] font-semibold text-slate-500">Product</div>
                      <div class="mt-0.5 text-slate-800">
                        {{ selectedRow.productCategory }} - {{ selectedRow.productName }}
                      </div>
                    </div>

                    <div>
                      <div class="text-[11px] font-semibold text-slate-500">Proposal</div>
                      <div class="mt-0.5 text-slate-800">
                        {{ selectedRow.amount | currency: selectedRow.currency:'symbol':'1.0-0' }}
                      </div>
                    </div>

                    <div>
                      <div class="text-[11px] font-semibold text-slate-500">Stage</div>
                      <div class="mt-0.5 text-slate-800">
                        {{ selectedRow.stage }}
                      </div>
                    </div>

                    <div>
                      <div class="text-[11px] font-semibold text-slate-500">SLA</div>
                      <div class="mt-0.5 text-slate-800 flex items-center gap-2">
                        <span>Due {{ selectedRow.slaDate | date: 'd MMM yyyy' }}</span>
                        <span class="inline-flex rounded-full px-2 py-0.5 text-[11px]"
                          [ngClass]="selectedRow.slaBreached ? 'bg-red-50 text-red-700' : 'bg-emerald-50 text-emerald-700'">
                          {{ selectedRow.slaBreached ? 'Overdue' : 'On Track' }}
                        </span>
                      </div>
                    </div>
                  </div>

                  <div *ngSwitchCase="'timeline'" class="space-y-3">
                    <div *ngFor="let event of selectedRow?.history" class="flex gap-3">
                      <div class="mt-1 h-2 w-2 rounded-full bg-blue-500"></div>
                      <div>
                        <div class="text-xs font-semibold text-slate-900">{{ event.status }}</div>
                        <div class="text-[11px] text-slate-500">
                          {{ event.date | date: 'd MMM yyyy' }} - {{ event.actor }}
                        </div>
                        <div *ngIf="event.comment" class="mt-0.5 text-[11px] text-slate-700">
                          {{ event.comment }}
                        </div>
                      </div>
                    </div>
                  </div>

                  <div *ngSwitchCase="'flags'" class="space-y-2">
                    <div class="flex items-center justify-between">
                      <div class="text-[11px] text-slate-500">SLA Breached</div>
                      <div class="text-xs font-medium text-slate-800">{{ selectedRow.slaBreached ? 'Yes' : 'No' }}</div>
                    </div>

                    <div class="flex items-center justify-between">
                      <div class="text-[11px] text-slate-500">Missing Docs</div>
                      <div class="text-xs font-medium text-slate-800">{{ selectedRow.missingDocs }}</div>
                    </div>

                    <div class="flex items-center justify-between">
                      <div class="text-[11px] text-slate-500">Open Queries</div>
                      <div class="text-xs font-medium text-slate-800">{{ selectedRow.openQueries }}</div>
                    </div>

                    <div class="flex items-center justify-between">
                      <div class="text-[11px] text-slate-500">Risk Grade</div>
                      <div class="text-xs font-medium text-slate-800">{{ selectedRow.riskGrade }}</div>
                    </div>
                  </div>
                </ng-container>
              </div>
            </div>
          </ng-container>
        </app-ui-side-modal>

      </div>
    </section>
  </div>
</app-loms-layout>
